generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMs
enum QuestionType {
  short_text
  long_text
  multiple_choice
  rating
  nps
}

enum SurveyStatus {
  draft
  active
  paused
  completed
}

enum AppRole {
  admin
  manager
  viewer
}

// ================================
// USERS & PROFILES
// ================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password_hash String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  profile           Profile?
  roles             UserRole[]
  created_roles     UserRole[]        @relation("RoleCreatedBy")
  surveys           Survey[]          @relation("UserSurveys")
  response_sessions ResponseSession[]

  @@map("users")
}

model Profile {
  id         String  @id
  full_name  String?
  avatar_url String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user    User     @relation(fields: [id], references: [id], onDelete: Cascade)
  surveys Survey[] @relation("SurveyCreator")

  response_sessions ResponseSession[]

  @@map("profiles")
}

model UserRole {
  id            String   @id @default(uuid())
  user_id       String
  role          AppRole  @default(viewer)
  created_at    DateTime @default(now())
  created_by_id String?

  // Relations
  user       User  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  created_by User? @relation("RoleCreatedBy", fields: [created_by_id], references: [id], onDelete: Cascade)

  @@unique([user_id, role])
  @@map("user_roles")
}

// ================================
// SURVEY
// ================================

model Survey {
  id          String       @id @default(uuid())
  title       String
  description String?
  status      SurveyStatus @default(draft)

  created_by_id String
  created_by    Profile @relation("SurveyCreator", fields: [created_by_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  published_at DateTime?
  closed_at    DateTime?

  allow_anonymous   Boolean @default(false)
  show_progress_bar Boolean @default(true)
  thank_you_message String  @default("Obrigado por participar!")

  total_responses Int     @default(0)
  is_template     Boolean @default(false)

  duplicated_from_id String?
  duplicated_from    Survey?  @relation("SurveyDuplications", fields: [duplicated_from_id], references: [id])
  duplicated_surveys Survey[] @relation("SurveyDuplications")

  user_id String?
  user   User?   @relation("UserSurveys", fields: [user_id], references: [id])

  question         Question[]
  response_session ResponseSession[]
  survey_metrics   SurveyMetrics?

  @@index([status])
  @@index([created_by_id])
  @@index([created_at(sort: Desc)])
  @@map("surveys")
}

// ================================
// QUESTIONS
// ================================

model Question {
  id            String       @id @default(uuid())
  survey_id     String
  question_text String
  question_type QuestionType
  order_index   Int
  is_required   Boolean      @default(true)
  min_rating    Int?         @default(1)
  max_rating    Int?         @default(5)
  max_length    Int?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  survey    Survey           @relation(fields: [survey_id], references: [id], onDelete: Cascade)
  options   QuestionOption[]
  responses Response[]

  @@unique([survey_id, order_index])
  @@index([survey_id, order_index])
  @@map("questions")
}

// ================================
// QUESTION OPTIONS
// ================================

model QuestionOption {
  id          String @id @default(uuid())
  question_id String
  option_text String
  order_index Int

  created_at DateTime @default(now())

  question  Question   @relation(fields: [question_id], references: [id], onDelete: Cascade)
  responses Response[]

  @@unique([question_id, order_index])
  @@index([question_id])
  @@map("question_options")
}

// ================================
// RESPONSE SESSION
// ================================

model ResponseSession {
  id                    String    @id @default(uuid())
  survey_id             String
  respondent_id         String?
  started_at            DateTime  @default(now())
  completed_at          DateTime?
  is_complete           Boolean   @default(false)
  respondent_user_agent String?
  time_spent_seconds    Int?

  survey     Survey     @relation(fields: [survey_id], references: [id], onDelete: Cascade)
  respondent Profile?   @relation(fields: [respondent_id], references: [id], onDelete: SetNull)
  responses  Response[]
  user       User?      @relation(fields: [user_id], references: [id])
  user_id     String?

  @@index([survey_id])
  @@index([respondent_id])
  @@index([survey_id, is_complete])
  @@map("response_sessions")
}

// ================================
// RESPONSE
// ================================

model Response {
  id                 String   @id @default(uuid())
  session_id         String
  question_id        String
  text_response      String?
  numeric_response   Int?
  selected_option_id String?
  answered_at        DateTime @default(now())

  session        ResponseSession @relation(fields: [session_id], references: [id], onDelete: Cascade)
  question       Question        @relation(fields: [question_id], references: [id], onDelete: Cascade)
  selected_option QuestionOption? @relation(fields: [selected_option_id], references: [id])

  @@unique([session_id, question_id])
  @@index([session_id])
  @@index([question_id])
  @@map("responses")
}

// ================================
// SURVEY METRICS
// ================================

model SurveyMetrics {
  survey_id String @id

  total_responses                 Int      @default(0)
  completed_responses             Int      @default(0)
  average_completion_time_seconds Int?
  completion_rate                 Decimal? @db.Decimal(5, 2)
  average_rating                  Decimal? @db.Decimal(3, 2)

  nps_score      Int?
  nps_promoters  Int  @default(0)
  nps_passives   Int  @default(0)
  nps_detractors Int  @default(0)

  csat_score Decimal? @db.Decimal(5, 2)

  last_calculated_at DateTime @default(now())
  updated_at         DateTime @updatedAt

  survey Survey @relation(fields: [survey_id], references: [id], onDelete: Cascade)

  @@map("survey_metrics")
}
