# Optei por node:20 (sem ser alpine) para evitar problemas com OpenSSL do Prisma, 
# mas se preferires o alpine, terÃ¡s de instalar o openssl manualmente.
FROM node:20

WORKDIR /usr/src/app

# Copia dependÃªncias primeiro (para aproveitar o cache do Docker)
COPY package*.json ./

RUN npm install

# Copia o cÃ³digo fonte
COPY . .

# Gera o cliente do Prisma (isso pode ser feito no build, pois gera apenas arquivos JS/TS)
RUN npx prisma generate

# Removemos o migrate daqui! âŒ

EXPOSE 3333

# O "Pulo do Gato" ğŸˆ
# Usamos 'sh -c' para rodar dois comandos em sequÃªncia:
# 1. Aplica as migraÃ§Ãµes pendentes no banco (npx prisma migrate deploy)
# 2. Inicia o servidor (npm run start:dev)
CMD ["sh", "-c", "npx prisma migrate deploy && npm run start:dev"]